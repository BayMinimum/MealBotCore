// From BayMinimum/MealTweet
const offlineData = require("./meal_offline")
module.exports = function (callback) {
  'use strict';
  let cheerio = require('cheerio');
  let https = require('https');
  let time = require('time');

  let now = new time.Date();
  now.setTimezone("Asia/Seoul");
  const yyyy = now.getFullYear();
  const mm = now.getMonth() + 1;
  const dd = now.getDate();

  let options = {
    host: "ksa.hs.kr",
    path: "/Home/CafeteriaMenu/72",
    rejectUnauthorized: false,
    agent: false
  };

  // get html data from school website
  let data = "";
  let request = https.request(options, function (res) {
    res.setEncoding("utf8");
    res.on('data', function (chunk) {
      data += chunk;
      console.log("received chunk");
    });
    res.on('end', function () {
      parseMeal(data);
    });
  });

  request.on('error', function () {
    console.log("Network error");
  });

  request.end();

  // pass meal as [breakfast, lunch, dinner] to callback func
  let parseMeal = function (html) {
    let $ = cheerio.load(html, {decodeEntities: false}); // option to avoid unicode hangul issue
    findMeal($, yyyy, mm, dd, (todayMeal) => {
      findMeal($, yyyy, mm, dd + 1, (tomorrowMeal) => {
        callback([todayMeal, tomorrowMeal])
      })
    })
  };

};

function generateLookupDate(yyyy, mm, dd) {
  let target = `${yyyy}-`;
  if (mm < 10) target += `0${mm}-`;
  else target += `${mm}-`;
  if (dd < 10) target += `0${dd}`;
  else target += `${dd}`;
  return target
}

function emojifyAllergyInfo(mealstr){
  return mealstr.replace(/‚ë†/g, "ü•ö")
                .replace(/‚ë°/g, "ü•õ")
                .replace(/‚ë¢/g, "(Î©îÎ∞Ä)")
                .replace(/‚ë£/g, "ü•ú")
                .replace(/‚ë§/g, "üáß")
                .replace(/‚ë•/g, "üçû")
                .replace(/‚ë¶/g, "üêü")
                .replace(/‚ëß/g, "ü¶Ä")
                .replace(/‚ë®/g, "üç§")
                .replace(/‚ë©/g, "üê∑")
                .replace(/‚ë™/g, "üçë")
                .replace(/‚ë´/g, "üçÖ")
                .replace(/‚ë¨/g, "(ÏïÑÌô©ÏÇ∞Î•ò)")
                .replace(/‚ë≠/g, "(Ìò∏Îëê)")
                .replace(/‚ëÆ/g, "üêî")
                .replace(/‚ëØ/g, "üêÇ")
                .replace(/‚ë∞/g, "ü¶ë")
                .replace(/‚ë±/g, "üêö")
                .replace(/‚ë≤/g, "üå≤")
}

function findMeal($, yyyy, mm, dd, callback) {
  let lookupDate = generateLookupDate(yyyy, mm, dd);
  let flag = false
  let meal = ["", "", ""];
  $(".meal-con").find('tr').each((i, elem) => {
    if ($(elem).find('th').toString().indexOf(lookupDate) >= 0) {
      $(elem).find('li').each((j, elem) => {
          let chunk = $(elem).toString()
            .replace("<li>", "")
            .replace("</li>", "")
            .replace(/ /g, "")
            .replace(/amp;/g, "")
            .replace("[Ï°∞Ïãù]", "")
            .replace("[Ï§ëÏãù]", "")
            .replace("[ÏÑùÏãù]", "")
            .replace(/,/g, "\n")
            .replace(/\n\n/g, "\n");
          try {
            if (chunk.charAt(chunk.length - 1) === '\n') chunk = chunk.substring(0, chunk.length - 1);
          } catch (exception) {
            console.log(exception);
            console.log("Substring operation for meal chunk failed!");
          }
          meal[j] = chunk;
        }
      );
      flag = true
    }
  });

  if (!flag) {
    let k = 0
    while (k < 3) {
      if (!meal[k]) meal[k] = offlineData[k][lookupDate]
      if (!meal[k]) meal[k] = ""
      k += 1
    }
  }

  k = 0
  while (k < 3) {
    meal[k] = emojifyAllergyInfo(meal[k])
    k += 1
  }

  callback(meal)
}